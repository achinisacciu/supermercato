-- MySQL Script generated by MySQL Workbench
-- Wed Sep 17 22:01:07 2025
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
-- -----------------------------------------------------
-- Schema supermercato
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Schema supermercato
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `supermercato` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ;
USE `supermercato` ;

-- -----------------------------------------------------
-- Table `supermercato`.`edifici`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`edifici` (
  `id_edificio` INT NOT NULL AUTO_INCREMENT,
  `nome_edificio` VARCHAR(100) NOT NULL,
  `indirizzo` VARCHAR(255) NULL DEFAULT NULL,
  `superficie_mq` INT NULL DEFAULT NULL,
  `funzione_principale` ENUM('Punto Vendita', 'Magazzino', 'Sede') NOT NULL,
  PRIMARY KEY (`id_edificio`))
ENGINE = InnoDB
AUTO_INCREMENT = 4
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`casse`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`casse` (
  `id_cassa` INT NOT NULL AUTO_INCREMENT,
  `numero_cassa` INT NOT NULL,
  `tipo` ENUM('Manuale', 'Automatica') NOT NULL,
  `stato` ENUM('Attiva', 'In manutenzione', 'Disattivata') NULL DEFAULT 'Attiva',
  `id_edificio` INT NOT NULL,
  PRIMARY KEY (`id_cassa`),
  INDEX `id_edificio` (`id_edificio` ASC) VISIBLE,
  CONSTRAINT `casse_ibfk_1`
    FOREIGN KEY (`id_edificio`)
    REFERENCES `supermercato`.`edifici` (`id_edificio`))
ENGINE = InnoDB
AUTO_INCREMENT = 23
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`fornitori`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`fornitori` (
  `id_fornitore` INT NOT NULL AUTO_INCREMENT,
  `nome_fornitore` VARCHAR(100) NOT NULL,
  `partita_iva` VARCHAR(20) NOT NULL,
  `email` VARCHAR(150) NULL DEFAULT NULL,
  `telefono` VARCHAR(20) NULL DEFAULT NULL,
  `affidabilita` TINYINT NULL DEFAULT NULL,
  PRIMARY KEY (`id_fornitore`),
  UNIQUE INDEX `partita_iva` (`partita_iva` ASC) VISIBLE)
ENGINE = InnoDB
AUTO_INCREMENT = 151
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`produttori`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`produttori` (
  `id_produttore` INT NOT NULL AUTO_INCREMENT,
  `nome_produttore` VARCHAR(100) NOT NULL,
  `nazione` VARCHAR(50) NULL DEFAULT NULL,
  `sito_web` VARCHAR(150) NULL DEFAULT NULL,
  `telefono` VARCHAR(20) NULL DEFAULT NULL,
  PRIMARY KEY (`id_produttore`))
ENGINE = InnoDB
AUTO_INCREMENT = 501
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`marche`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`marche` (
  `id_marca` INT NOT NULL AUTO_INCREMENT,
  `nome_marca` VARCHAR(100) NOT NULL,
  `id_produttore` INT NOT NULL,
  PRIMARY KEY (`id_marca`),
  INDEX `id_produttore` (`id_produttore` ASC) VISIBLE,
  CONSTRAINT `marche_ibfk_1`
    FOREIGN KEY (`id_produttore`)
    REFERENCES `supermercato`.`produttori` (`id_produttore`))
ENGINE = InnoDB
AUTO_INCREMENT = 512
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`categorie`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`categorie` (
  `id_categoria` INT NOT NULL AUTO_INCREMENT,
  `nome_categoria` VARCHAR(100) NOT NULL,
  `descrizione` TEXT NULL DEFAULT NULL,
  PRIMARY KEY (`id_categoria`))
ENGINE = InnoDB
AUTO_INCREMENT = 110
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`sottocategorie`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`sottocategorie` (
  `id_sottocategoria` INT NOT NULL AUTO_INCREMENT,
  `nome_sottocategoria` VARCHAR(100) NOT NULL,
  `id_categoria` INT NOT NULL,
  PRIMARY KEY (`id_sottocategoria`),
  INDEX `id_categoria` (`id_categoria` ASC) VISIBLE,
  CONSTRAINT `sottocategorie_ibfk_1`
    FOREIGN KEY (`id_categoria`)
    REFERENCES `supermercato`.`categorie` (`id_categoria`))
ENGINE = InnoDB
AUTO_INCREMENT = 437
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`prodotti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`prodotti` (
  `id_prodotto` INT NOT NULL AUTO_INCREMENT,
  `nome_prodotto` VARCHAR(150) NOT NULL,
  `prezzo_vendita` DECIMAL(10,2) NOT NULL,
  `peso_kg` DECIMAL(6,3) NULL DEFAULT NULL,
  `volume_cm3` INT NULL DEFAULT NULL,
  `id_marca` INT NOT NULL,
  `id_sottocategoria` INT NOT NULL,
  `scadenza` DATE NULL DEFAULT NULL,
  `is_alimentare` TINYINT(1) NULL DEFAULT '1',
  PRIMARY KEY (`id_prodotto`),
  INDEX `id_marca` (`id_marca` ASC) VISIBLE,
  INDEX `id_sottocategoria` (`id_sottocategoria` ASC) VISIBLE,
  CONSTRAINT `prodotti_ibfk_1`
    FOREIGN KEY (`id_marca`)
    REFERENCES `supermercato`.`marche` (`id_marca`),
  CONSTRAINT `prodotti_ibfk_2`
    FOREIGN KEY (`id_sottocategoria`)
    REFERENCES `supermercato`.`sottocategorie` (`id_sottocategoria`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`catalogo_fornitori`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`catalogo_fornitori` (
  `id_fornitore` INT NOT NULL,
  `id_prodotto` INT NOT NULL,
  `prezzo_offerta` DECIMAL(10,2) NOT NULL,
  `data_inizio` DATE NOT NULL,
  `data_fine` DATE NOT NULL,
  PRIMARY KEY (`id_fornitore`, `id_prodotto`),
  INDEX `id_prodotto` (`id_prodotto` ASC) VISIBLE,
  CONSTRAINT `catalogo_fornitori_ibfk_1`
    FOREIGN KEY (`id_fornitore`)
    REFERENCES `supermercato`.`fornitori` (`id_fornitore`),
  CONSTRAINT `catalogo_fornitori_ibfk_2`
    FOREIGN KEY (`id_prodotto`)
    REFERENCES `supermercato`.`prodotti` (`id_prodotto`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`clienti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`clienti` (
  `id_cliente` INT NOT NULL AUTO_INCREMENT,
  `nome` VARCHAR(100) NOT NULL,
  `cognome` VARCHAR(100) NOT NULL,
  `data_nascita` DATE NOT NULL,
  `sesso` ENUM('M', 'F', 'Altro') NULL DEFAULT NULL,
  `lavoro` VARCHAR(150) NULL DEFAULT NULL,
  `email` VARCHAR(150) NULL DEFAULT NULL,
  `telefono` VARCHAR(20) NULL DEFAULT NULL,
  `residenza` VARCHAR(255) NULL DEFAULT NULL,
  `newsletter` TINYINT(1) NULL DEFAULT '0',
  PRIMARY KEY (`id_cliente`),
  UNIQUE INDEX `email` (`email` ASC) VISIBLE,
  UNIQUE INDEX `telefono` (`telefono` ASC) VISIBLE)
ENGINE = InnoDB
AUTO_INCREMENT = 1001
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`titoli`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`titoli` (
  `id_titolo` INT NOT NULL AUTO_INCREMENT,
  `nome_titolo` VARCHAR(100) NOT NULL,
  `ente_emittente` VARCHAR(100) NULL DEFAULT NULL,
  `data_conseguimento` DATE NULL DEFAULT NULL,
  `data_scadenza` DATE NULL DEFAULT NULL,
  `eqf` INT NULL DEFAULT NULL,
  PRIMARY KEY (`id_titolo`))
ENGINE = InnoDB
AUTO_INCREMENT = 28
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`clienti_titoli`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`clienti_titoli` (
  `id_cliente` INT NOT NULL,
  `id_titolo` INT NOT NULL,
  PRIMARY KEY (`id_cliente`, `id_titolo`),
  INDEX `id_titolo` (`id_titolo` ASC) VISIBLE,
  CONSTRAINT `clienti_titoli_ibfk_1`
    FOREIGN KEY (`id_cliente`)
    REFERENCES `supermercato`.`clienti` (`id_cliente`),
  CONSTRAINT `clienti_titoli_ibfk_2`
    FOREIGN KEY (`id_titolo`)
    REFERENCES `supermercato`.`titoli` (`id_titolo`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`ordini_fornitore`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`ordini_fornitore` (
  `id_ordine` INT NOT NULL AUTO_INCREMENT,
  `id_fornitore` INT NOT NULL,
  `data_ordine` DATE NOT NULL,
  `data_prevista_consegna` DATE NULL DEFAULT NULL,
  `stato` ENUM('In attesa', 'Consegnato', 'Annullato') NULL DEFAULT 'In attesa',
  PRIMARY KEY (`id_ordine`),
  INDEX `id_fornitore` (`id_fornitore` ASC) VISIBLE,
  CONSTRAINT `ordini_fornitore_ibfk_1`
    FOREIGN KEY (`id_fornitore`)
    REFERENCES `supermercato`.`fornitori` (`id_fornitore`))
ENGINE = InnoDB
AUTO_INCREMENT = 85051
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`dettagli_ordine`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`dettagli_ordine` (
  `id_dettaglio` INT NOT NULL AUTO_INCREMENT,
  `id_ordine` INT NOT NULL,
  `id_prodotto` INT NOT NULL,
  `quantita` INT NOT NULL,
  `prezzo_unitario` DECIMAL(10,2) NOT NULL,
  PRIMARY KEY (`id_dettaglio`),
  INDEX `id_ordine` (`id_ordine` ASC) VISIBLE,
  INDEX `id_prodotto` (`id_prodotto` ASC) VISIBLE,
  CONSTRAINT `dettagli_ordine_ibfk_1`
    FOREIGN KEY (`id_ordine`)
    REFERENCES `supermercato`.`ordini_fornitore` (`id_ordine`),
  CONSTRAINT `dettagli_ordine_ibfk_2`
    FOREIGN KEY (`id_prodotto`)
    REFERENCES `supermercato`.`prodotti` (`id_prodotto`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`ruoli`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`ruoli` (
  `id_ruolo` INT NOT NULL AUTO_INCREMENT,
  `nome_ruolo` VARCHAR(100) NOT NULL,
  `descrizione` TEXT NULL DEFAULT NULL,
  PRIMARY KEY (`id_ruolo`))
ENGINE = InnoDB
AUTO_INCREMENT = 34
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`uffici`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`uffici` (
  `id_ufficio` INT NOT NULL AUTO_INCREMENT,
  `nome_ufficio` VARCHAR(100) NOT NULL,
  `piano` INT NULL DEFAULT NULL,
  `id_edificio` INT NOT NULL,
  PRIMARY KEY (`id_ufficio`),
  INDEX `id_edificio` (`id_edificio` ASC) VISIBLE,
  CONSTRAINT `uffici_ibfk_1`
    FOREIGN KEY (`id_edificio`)
    REFERENCES `supermercato`.`edifici` (`id_edificio`))
ENGINE = InnoDB
AUTO_INCREMENT = 16
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`dipendenti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`dipendenti` (
  `id_dipendente` INT NOT NULL AUTO_INCREMENT,
  `nome` VARCHAR(100) NOT NULL,
  `cognome` VARCHAR(100) NOT NULL,
  `data_nascita` DATE NOT NULL,
  `email` VARCHAR(150) NULL DEFAULT NULL,
  `telefono` VARCHAR(20) NULL DEFAULT NULL,
  `data_assunzione` DATE NOT NULL,
  `stipendio` DECIMAL(10,2) NULL DEFAULT NULL,
  `id_ruolo` INT NOT NULL,
  `id_ufficio` INT NOT NULL,
  PRIMARY KEY (`id_dipendente`),
  UNIQUE INDEX `email` (`email` ASC) VISIBLE,
  INDEX `id_ruolo` (`id_ruolo` ASC) VISIBLE,
  INDEX `id_ufficio` (`id_ufficio` ASC) VISIBLE,
  CONSTRAINT `dipendenti_ibfk_1`
    FOREIGN KEY (`id_ruolo`)
    REFERENCES `supermercato`.`ruoli` (`id_ruolo`),
  CONSTRAINT `dipendenti_ibfk_2`
    FOREIGN KEY (`id_ufficio`)
    REFERENCES `supermercato`.`uffici` (`id_ufficio`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`documenti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`documenti` (
  `id_documento` INT NOT NULL AUTO_INCREMENT,
  `tipo_documento` ENUM('Scontrino', 'Fattura') NOT NULL,
  `data_documento` DATE NOT NULL,
  `ora_documento` TIME NOT NULL,
  `modalita_pagamento` ENUM('Contanti', 'Carta di Credito', 'Carta di Debito', 'Digital Wallet') NOT NULL,
  `importo` DECIMAL(10,2) NOT NULL,
  `id_cassa` INT NOT NULL,
  `id_dipendente` INT NOT NULL,
  `id_cliente` INT NULL DEFAULT NULL,
  PRIMARY KEY (`id_documento`),
  INDEX `id_cassa` (`id_cassa` ASC) VISIBLE,
  INDEX `id_dipendente` (`id_dipendente` ASC) VISIBLE,
  INDEX `id_cliente` (`id_cliente` ASC) VISIBLE,
  CONSTRAINT `documenti_ibfk_1`
    FOREIGN KEY (`id_cassa`)
    REFERENCES `supermercato`.`casse` (`id_cassa`),
  CONSTRAINT `documenti_ibfk_2`
    FOREIGN KEY (`id_dipendente`)
    REFERENCES `supermercato`.`dipendenti` (`id_dipendente`),
  CONSTRAINT `documenti_ibfk_3`
    FOREIGN KEY (`id_cliente`)
    REFERENCES `supermercato`.`clienti` (`id_cliente`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`dettagli_scontrino`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`dettagli_scontrino` (
  `id_dettaglio` INT NOT NULL AUTO_INCREMENT,
  `id_documento` INT NOT NULL,
  `id_prodotto` INT NOT NULL,
  `quantita` INT NOT NULL,
  `prezzo_unitario` DECIMAL(10,2) NOT NULL,
  `sconto_percentuale` DECIMAL(5,2) NULL DEFAULT '0.00',
  PRIMARY KEY (`id_dettaglio`),
  INDEX `id_documento` (`id_documento` ASC) VISIBLE,
  INDEX `id_prodotto` (`id_prodotto` ASC) VISIBLE,
  CONSTRAINT `dettagli_scontrino_ibfk_1`
    FOREIGN KEY (`id_documento`)
    REFERENCES `supermercato`.`documenti` (`id_documento`),
  CONSTRAINT `dettagli_scontrino_ibfk_2`
    FOREIGN KEY (`id_prodotto`)
    REFERENCES `supermercato`.`prodotti` (`id_prodotto`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`dipendenti_titoli`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`dipendenti_titoli` (
  `id_dipendente` INT NOT NULL,
  `id_titolo` INT NOT NULL,
  PRIMARY KEY (`id_dipendente`, `id_titolo`),
  INDEX `id_titolo` (`id_titolo` ASC) VISIBLE,
  CONSTRAINT `dipendenti_titoli_ibfk_1`
    FOREIGN KEY (`id_dipendente`)
    REFERENCES `supermercato`.`dipendenti` (`id_dipendente`),
  CONSTRAINT `dipendenti_titoli_ibfk_2`
    FOREIGN KEY (`id_titolo`)
    REFERENCES `supermercato`.`titoli` (`id_titolo`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`reparti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`reparti` (
  `id_reparto` INT NOT NULL AUTO_INCREMENT,
  `nome_reparto` VARCHAR(100) NOT NULL,
  `descrizione` TEXT NULL DEFAULT NULL,
  PRIMARY KEY (`id_reparto`))
ENGINE = InnoDB
AUTO_INCREMENT = 17
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`scaffali`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`scaffali` (
  `id_scaffale` INT NOT NULL AUTO_INCREMENT,
  `tipo` ENUM('Normale', 'Frigorifero', 'Congelatore') NOT NULL,
  `capacita_peso` DECIMAL(10,2) NOT NULL,
  `capacita_volume` DECIMAL(10,2) NOT NULL,
  `id_reparto` INT NOT NULL,
  PRIMARY KEY (`id_scaffale`),
  INDEX `id_reparto` (`id_reparto` ASC) VISIBLE,
  CONSTRAINT `scaffali_ibfk_1`
    FOREIGN KEY (`id_reparto`)
    REFERENCES `supermercato`.`reparti` (`id_reparto`))
ENGINE = InnoDB
AUTO_INCREMENT = 60
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`inventario`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`inventario` (
  `id_inventario` INT NOT NULL AUTO_INCREMENT,
  `id_prodotto` INT NOT NULL,
  `id_scaffale` INT NOT NULL,
  `id_reparto` INT NOT NULL,
  `id_edificio` INT NOT NULL,
  `quantita` INT NOT NULL DEFAULT '0',
  `data_ultimo_aggiornamento` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_inventario`),
  INDEX `id_prodotto` (`id_prodotto` ASC) VISIBLE,
  INDEX `id_scaffale` (`id_scaffale` ASC) VISIBLE,
  INDEX `id_reparto` (`id_reparto` ASC) VISIBLE,
  INDEX `id_edificio` (`id_edificio` ASC) VISIBLE,
  CONSTRAINT `inventario_ibfk_1`
    FOREIGN KEY (`id_prodotto`)
    REFERENCES `supermercato`.`prodotti` (`id_prodotto`),
  CONSTRAINT `inventario_ibfk_2`
    FOREIGN KEY (`id_scaffale`)
    REFERENCES `supermercato`.`scaffali` (`id_scaffale`),
  CONSTRAINT `inventario_ibfk_3`
    FOREIGN KEY (`id_reparto`)
    REFERENCES `supermercato`.`reparti` (`id_reparto`),
  CONSTRAINT `inventario_ibfk_4`
    FOREIGN KEY (`id_edificio`)
    REFERENCES `supermercato`.`edifici` (`id_edificio`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`prodotti_scaffali`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`prodotti_scaffali` (
  `id_prodotto` INT NOT NULL,
  `id_scaffale` INT NOT NULL,
  `quantita` INT NOT NULL,
  `data_collocazione` DATE NOT NULL,
  PRIMARY KEY (`id_prodotto`, `id_scaffale`),
  INDEX `id_scaffale` (`id_scaffale` ASC) VISIBLE,
  CONSTRAINT `prodotti_scaffali_ibfk_1`
    FOREIGN KEY (`id_prodotto`)
    REFERENCES `supermercato`.`prodotti` (`id_prodotto`),
  CONSTRAINT `prodotti_scaffali_ibfk_2`
    FOREIGN KEY (`id_scaffale`)
    REFERENCES `supermercato`.`scaffali` (`id_scaffale`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`promozioni`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`promozioni` (
  `id_promozione` INT NOT NULL AUTO_INCREMENT,
  `nome` VARCHAR(100) NOT NULL,
  `descrizione` TEXT NULL DEFAULT NULL,
  `sconto_percentuale` DECIMAL(5,2) NULL DEFAULT NULL,
  `data_inizio` DATE NOT NULL,
  `data_fine` DATE NOT NULL,
  PRIMARY KEY (`id_promozione`))
ENGINE = InnoDB
AUTO_INCREMENT = 13
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`promozioni_prodotti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`promozioni_prodotti` (
  `id_promozione` INT NOT NULL,
  `id_prodotto` INT NOT NULL,
  PRIMARY KEY (`id_promozione`, `id_prodotto`),
  INDEX `id_prodotto` (`id_prodotto` ASC) VISIBLE,
  CONSTRAINT `promozioni_prodotti_ibfk_1`
    FOREIGN KEY (`id_promozione`)
    REFERENCES `supermercato`.`promozioni` (`id_promozione`),
  CONSTRAINT `promozioni_prodotti_ibfk_2`
    FOREIGN KEY (`id_prodotto`)
    REFERENCES `supermercato`.`prodotti` (`id_prodotto`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`reparto_edificio`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`reparto_edificio` (
  `id_reparto` INT NOT NULL,
  `id_edificio` INT NOT NULL,
  PRIMARY KEY (`id_reparto`, `id_edificio`),
  INDEX `id_edificio` (`id_edificio` ASC) VISIBLE,
  CONSTRAINT `reparto_edificio_ibfk_1`
    FOREIGN KEY (`id_reparto`)
    REFERENCES `supermercato`.`reparti` (`id_reparto`),
  CONSTRAINT `reparto_edificio_ibfk_2`
    FOREIGN KEY (`id_edificio`)
    REFERENCES `supermercato`.`edifici` (`id_edificio`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `supermercato`.`ruoli_titoli`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`ruoli_titoli` (
  `id_ruolo` INT NOT NULL,
  `id_titolo` INT NOT NULL,
  PRIMARY KEY (`id_ruolo`, `id_titolo`),
  INDEX `id_titolo` (`id_titolo` ASC) VISIBLE,
  CONSTRAINT `ruoli_titoli_ibfk_1`
    FOREIGN KEY (`id_ruolo`)
    REFERENCES `supermercato`.`ruoli` (`id_ruolo`),
  CONSTRAINT `ruoli_titoli_ibfk_2`
    FOREIGN KEY (`id_titolo`)
    REFERENCES `supermercato`.`titoli` (`id_titolo`))
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;

USE `supermercato` ;

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_average_order_value`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_average_order_value` (`aov` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_cannibalizzazione_promozioni`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_cannibalizzazione_promozioni` (`prodotto_promozione_1` INT, `prodotto_promozione_2` INT, `scontrini_comuni` INT, `qta_prodotto_1` INT, `qta_prodotto_2` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_carrello_medio_cliente`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_carrello_medio_cliente` (`id_cliente` INT, `nome` INT, `cognome` INT, `carrello_medio` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_carrello_medio_tipologia`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_carrello_medio_tipologia` (`lavoro` INT, `carrello_medio` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_clienti_registrati_vs_anonimi`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_clienti_registrati_vs_anonimi` (`vendite_clienti_registrati` INT, `vendite_clienti_anonimi` INT, `totale_vendite` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_clienti_ritorno`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_clienti_ritorno` (`clienti_ritorno` INT, `clienti_una_volta` INT, `totale_clienti` INT, `tasso_retention_percent` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_cross_selling_promozioni`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_cross_selling_promozioni` (`id_promozione` INT, `promozione` INT, `scontrini_con_promozione` INT, `scontrini_con_altri_prodotti` INT, `percentuale_cross_selling` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_customer_lifetime_value`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_customer_lifetime_value` (`id_cliente` INT, `nome` INT, `cognome` INT, `totale_speso` INT, `numero_acquisti` INT, `spesa_media_per_acquisto` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_distribuzione_peso_volume_scaffali`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_distribuzione_peso_volume_scaffali` (`id_scaffale` INT, `tipo` INT, `peso_totale` INT, `volume_totale` INT, `utilizzo_peso_percent` INT, `utilizzo_volume_percent` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_efficienza_casse`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_efficienza_casse` (`id_cassa` INT, `tipo_cassa` INT, `numero_scontrini` INT, `ricavi_totali` INT, `euro_per_ora` INT, `scontrini_per_ora` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_efficienza_mq`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_efficienza_mq` (`id_edificio` INT, `nome_edificio` INT, `superficie_mq` INT, `ricavi_totali` INT, `ricavi_per_mq` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_fornitori_affidabili`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_fornitori_affidabili` (`id_fornitore` INT, `nome_fornitore` INT, `affidabilita` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_fornitori_convenienti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_fornitori_convenienti` (`id_fornitore` INT, `nome_fornitore` INT, `prezzo_medio_offerta` INT, `prezzo_medio_vendita` INT, `margine_medio` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_frequenza_vendita_prodotto`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_frequenza_vendita_prodotto` (`id_prodotto` INT, `nome_prodotto` INT, `frequenza_vendita` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_impatto_promozioni_vendite`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_impatto_promozioni_vendite` (`stato_promozione` INT, `totale_quantita` INT, `ricavi_totali` INT, `sconto_medio` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_margine_lordo_prodotti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_margine_lordo_prodotti` (`id_prodotto` INT, `nome_prodotto` INT, `prezzo_medio_vendita` INT, `prezzo_medio_acquisto` INT, `margine_lordo_unitario` INT, `vendite_totali` INT, `margine_totale` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_performance_edifici`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_performance_edifici` (`id_edificio` INT, `nome_edificio` INT, `indirizzo` INT, `ricavi_totali` INT, `numero_scontrini` INT, `carrello_medio` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_performance_marche`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_performance_marche` (`id_marca` INT, `nome_marca` INT, `quantita_venduta` INT, `ricavi_totali` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_performance_produttori`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_performance_produttori` (`id_produttore` INT, `nome_produttore` INT, `quantita_venduta` INT, `ricavi_totali` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_performance_titoli`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_performance_titoli` (`nome_titolo` INT, `numero_dipendenti` INT, `ricavi_totali` INT, `media_vendite_per_dipendente` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_picchi_carico`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_picchi_carico` (`data_documento` INT, `ora` INT, `numero_scontrini` INT, `cassieri_attivi` INT, `scontrini_per_cassiere` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_prezzo_vs_volumi`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_prezzo_vs_volumi` (`id_prodotto` INT, `nome_prodotto` INT, `prezzo_medio_acquisto` INT, `quantita_venduta` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_prodotti_associati`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_prodotti_associati` (`prodotto_1` INT, `prodotto_2` INT, `frequenza` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_prodotti_cari_ma_lenti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_prodotti_cari_ma_lenti` (`id_prodotto` INT, `nome_prodotto` INT, `prezzo_medio_vendita` INT, `quantita_venduta` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_prodotti_meno_venduti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_prodotti_meno_venduti` (`id_prodotto` INT, `nome_prodotto` INT, `totale_venduto` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_prodotti_piu_venduti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_prodotti_piu_venduti` (`id_prodotto` INT, `nome_prodotto` INT, `totale_venduto` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_prodotti_stockout`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_prodotti_stockout` (`id_prodotto` INT, `nome_prodotto` INT, `volte_stockout` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_produttivita_ruolo`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_produttivita_ruolo` (`id_ruolo` INT, `nome_ruolo` INT, `numero_dipendenti` INT, `stipendio_medio` INT, `ricavi_totali` INT, `ricavi_per_dipendente` INT, `rapporto_stipendio_produttivita` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_promozioni_vs_vendite`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_promozioni_vs_vendite` (`id_prodotto` INT, `nome_prodotto` INT, `numero_promozioni` INT, `quantita_venduta` INT, `ricavi_generati` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_quantita_venduta_prodotto`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_quantita_venduta_prodotto` (`id_prodotto` INT, `nome_prodotto` INT, `quantita_totale` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_redditivita_per_lavoro`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_redditivita_per_lavoro` (`lavoro` INT, `ricavo_totale` INT, `spesa_media` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_redditivita_per_sesso`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_redditivita_per_sesso` (`sesso` INT, `ricavo_totale` INT, `spesa_media` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_ricavi_per_categoria`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_ricavi_per_categoria` (`id_categoria` INT, `nome_categoria` INT, `ricavi_totali` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_ricavi_per_sottocategoria`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_ricavi_per_sottocategoria` (`id_sottocategoria` INT, `nome_sottocategoria` INT, `ricavi_totali` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_ricavi_reparti`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_ricavi_reparti` (`id` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_ricavo_per_categoria`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_ricavo_per_categoria` (`id_categoria` INT, `nome_categoria` INT, `ricavo_categoria` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_ricavo_per_prodotto`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_ricavo_per_prodotto` (`id_prodotto` INT, `nome_prodotto` INT, `ricavo_prodotto` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_ricavo_totale`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_ricavo_totale` (`ricavo_totale` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_roi_promozioni`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_roi_promozioni` (`id_promozione` INT, `nome` INT, `data_inizio` INT, `data_fine` INT, `ricavi_lordi` INT, `valore_sconti` INT, `ricavi_netto` INT, `roi_stimato` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_rotazione_alimentare_vs_non`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_rotazione_alimentare_vs_non` (`tipo_prodotto` INT, `vendite_totali` INT, `giacenza_media` INT, `tasso_rotazione` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_rotazione_magazzino`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_rotazione_magazzino` (`id_prodotto` INT, `nome_prodotto` INT, `vendite_totali` INT, `giacenza_media` INT, `tasso_rotazione` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_sconto_medio_prodotto`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_sconto_medio_prodotto` (`id_prodotto` INT, `nome_prodotto` INT, `sconto_medio` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_sconto_medio_totale`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_sconto_medio_totale` (`sconto_medio_totale` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_sottocategorie_low_performance`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_sottocategorie_low_performance` (`id_sottocategoria` INT, `nome_sottocategoria` INT, `numero_scontrini` INT, `ricavi_totali` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_spesa_per_eta`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_spesa_per_eta` (`fascia_eta` INT, `ricavo_totale` INT, `spesa_media` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_tempo_consegna_fornitori`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_tempo_consegna_fornitori` (`id` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_utilizzo_scaffali`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_utilizzo_scaffali` (`id_scaffale` INT, `tipo` INT, `capacita_peso` INT, `capacita_volume` INT, `peso_totale` INT, `volume_totale` INT, `utilizzo_peso_percent` INT, `utilizzo_volume_percent` INT, `stato_scaffale` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_vendite_giornaliere`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_vendite_giornaliere` (`giorno` INT, `totale_giornaliero` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_vendite_mensili`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_vendite_mensili` (`anno` INT, `mese` INT, `totale_mensile` INT);

-- -----------------------------------------------------
-- Placeholder table for view `supermercato`.`vw_vendite_settimanali`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `supermercato`.`vw_vendite_settimanali` (`anno_settimana` INT, `totale_settimanale` INT);

-- -----------------------------------------------------
-- function calcola_totale_scontrino
-- -----------------------------------------------------

DELIMITER $$
USE `supermercato`$$
CREATE DEFINER=`root`@`localhost` FUNCTION `calcola_totale_scontrino`(p_id_documento INT) RETURNS decimal(10,2)
    READS SQL DATA
    DETERMINISTIC
BEGIN
    DECLARE totale DECIMAL(10,2);
    
    SELECT COALESCE(SUM(
        prezzo_unitario * quantita * (1 - sconto_percentuale/100)
    ), 0)
    INTO totale
    FROM dettagli_scontrino
    WHERE id_documento = p_id_documento;
    
    RETURN totale;
END$$

DELIMITER ;

-- -----------------------------------------------------
-- function verifica_disponibilita_prodotto
-- -----------------------------------------------------

DELIMITER $$
USE `supermercato`$$
CREATE DEFINER=`root`@`localhost` FUNCTION `verifica_disponibilita_prodotto`(p_id_prodotto INT) RETURNS int
    READS SQL DATA
    DETERMINISTIC
BEGIN
    DECLARE quantita_totale INT;
    
    SELECT COALESCE(SUM(quantita), 0)
    INTO quantita_totale
    FROM prodotti_scaffali
    WHERE id_prodotto = p_id_prodotto;
    
    RETURN quantita_totale;
END$$

DELIMITER ;

-- -----------------------------------------------------
-- procedure verifica_integrita_database
-- -----------------------------------------------------

DELIMITER $$
USE `supermercato`$$
CREATE DEFINER=`root`@`localhost` PROCEDURE `verifica_integrita_database`()
BEGIN
    DECLARE errori_trovati INT DEFAULT 0;
    DECLARE messaggio VARCHAR(500);
    
    -- Verifica dipendenti minorenni
    SELECT COUNT(*) INTO @count_err
    FROM dipendenti
    WHERE TIMESTAMPDIFF(YEAR, data_nascita, CURDATE()) < 18;
    
    IF @count_err > 0 THEN
        SET errori_trovati = errori_trovati + @count_err;
        SET messaggio = CONCAT('Trovati ', @count_err, ' dipendenti minorenni');
        SELECT messaggio AS 'Errore';
    END IF;
    
    -- Verifica prodotti alimentari senza scadenza
    SELECT COUNT(*) INTO @count_err
    FROM prodotti
    WHERE is_alimentare = TRUE AND scadenza IS NULL;
    
    IF @count_err > 0 THEN
        SET errori_trovati = errori_trovati + @count_err;
        SET messaggio = CONCAT('Trovati ', @count_err, ' prodotti alimentari senza data di scadenza');
        SELECT messaggio AS 'Errore';
    END IF;
    
    -- Verifica scaffali sovraccarichi
    SELECT COUNT(*) INTO @count_err
    FROM (
        SELECT s.id_scaffale
        FROM scaffali s
        LEFT JOIN (
            SELECT ps.id_scaffale,
                   SUM(p.peso_kg * ps.quantita) as peso_totale,
                   SUM(p.volume_cm3 * ps.quantita) as volume_totale
            FROM prodotti_scaffali ps
            INNER JOIN prodotti p ON ps.id_prodotto = p.id_prodotto
            GROUP BY ps.id_scaffale
        ) calcoli ON s.id_scaffale = calcoli.id_scaffale
        WHERE calcoli.peso_totale > s.capacita_peso 
           OR calcoli.volume_totale > s.capacita_volume
    ) AS scaffali_sovraccarichi;
    
    IF @count_err > 0 THEN
        SET errori_trovati = errori_trovati + @count_err;
        SET messaggio = CONCAT('Trovati ', @count_err, ' scaffali sovraccarichi');
        SELECT messaggio AS 'Errore';
    END IF;
    
    IF errori_trovati = 0 THEN
        SELECT 'Database integro: nessun errore di vincolo trovato' AS 'Risultato';
    ELSE
        SELECT CONCAT('Totale errori trovati: ', errori_trovati) AS 'Risultato';
    END IF;
END$$

DELIMITER ;

-- -----------------------------------------------------
-- View `supermercato`.`vw_average_order_value`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_average_order_value`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_average_order_value` AS select avg(`d`.`importo`) AS `aov` from `supermercato`.`documenti` `d` where (`d`.`tipo_documento` = 'Scontrino');

-- -----------------------------------------------------
-- View `supermercato`.`vw_cannibalizzazione_promozioni`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_cannibalizzazione_promozioni`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_cannibalizzazione_promozioni` AS select `p1`.`nome_prodotto` AS `prodotto_promozione_1`,`p2`.`nome_prodotto` AS `prodotto_promozione_2`,count(distinct `ds1`.`id_documento`) AS `scontrini_comuni`,sum(`ds1`.`quantita`) AS `qta_prodotto_1`,sum(`ds2`.`quantita`) AS `qta_prodotto_2` from (((((`supermercato`.`promozioni_prodotti` `pp1` join `supermercato`.`promozioni_prodotti` `pp2` on(((`pp1`.`id_promozione` = `pp2`.`id_promozione`) and (`pp1`.`id_prodotto` < `pp2`.`id_prodotto`)))) join `supermercato`.`prodotti` `p1` on((`pp1`.`id_prodotto` = `p1`.`id_prodotto`))) join `supermercato`.`prodotti` `p2` on((`pp2`.`id_prodotto` = `p2`.`id_prodotto`))) join `supermercato`.`dettagli_scontrino` `ds1` on((`p1`.`id_prodotto` = `ds1`.`id_prodotto`))) join `supermercato`.`dettagli_scontrino` `ds2` on(((`p2`.`id_prodotto` = `ds2`.`id_prodotto`) and (`ds1`.`id_documento` = `ds2`.`id_documento`)))) group by `p1`.`nome_prodotto`,`p2`.`nome_prodotto` order by `scontrini_comuni` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_carrello_medio_cliente`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_carrello_medio_cliente`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_carrello_medio_cliente` AS select `c`.`id_cliente` AS `id_cliente`,`c`.`nome` AS `nome`,`c`.`cognome` AS `cognome`,avg(`d`.`importo`) AS `carrello_medio` from (`supermercato`.`documenti` `d` join `supermercato`.`clienti` `c` on((`d`.`id_cliente` = `c`.`id_cliente`))) where (`d`.`tipo_documento` = 'Scontrino') group by `c`.`id_cliente`,`c`.`nome`,`c`.`cognome` order by `carrello_medio` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_carrello_medio_tipologia`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_carrello_medio_tipologia`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_carrello_medio_tipologia` AS select `c`.`lavoro` AS `lavoro`,avg(`d`.`importo`) AS `carrello_medio` from (`supermercato`.`documenti` `d` join `supermercato`.`clienti` `c` on((`d`.`id_cliente` = `c`.`id_cliente`))) where (`d`.`tipo_documento` = 'Scontrino') group by `c`.`lavoro` order by `carrello_medio` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_clienti_registrati_vs_anonimi`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_clienti_registrati_vs_anonimi`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_clienti_registrati_vs_anonimi` AS select sum((case when (`d`.`id_cliente` is not null) then 1 else 0 end)) AS `vendite_clienti_registrati`,sum((case when (`d`.`id_cliente` is null) then 1 else 0 end)) AS `vendite_clienti_anonimi`,count(0) AS `totale_vendite` from `supermercato`.`documenti` `d` where (`d`.`tipo_documento` = 'Scontrino');

-- -----------------------------------------------------
-- View `supermercato`.`vw_clienti_ritorno`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_clienti_ritorno`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_clienti_ritorno` AS select count(distinct (case when (`sub`.`cnt` > 1) then `sub`.`id_cliente` end)) AS `clienti_ritorno`,count(distinct (case when (`sub`.`cnt` = 1) then `sub`.`id_cliente` end)) AS `clienti_una_volta`,count(distinct `sub`.`id_cliente`) AS `totale_clienti`,round(((count(distinct (case when (`sub`.`cnt` > 1) then `sub`.`id_cliente` end)) * 100.0) / count(distinct `sub`.`id_cliente`)),2) AS `tasso_retention_percent` from (select `d`.`id_cliente` AS `id_cliente`,count(0) AS `cnt` from `supermercato`.`documenti` `d` where ((`d`.`tipo_documento` = 'Scontrino') and (`d`.`id_cliente` is not null)) group by `d`.`id_cliente`) `sub`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_cross_selling_promozioni`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_cross_selling_promozioni`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_cross_selling_promozioni` AS select `pr`.`id_promozione` AS `id_promozione`,`pr`.`nome` AS `promozione`,count(distinct `d`.`id_documento`) AS `scontrini_con_promozione`,count(distinct (case when (`ds2`.`id_prodotto` is not null) then `d`.`id_documento` end)) AS `scontrini_con_altri_prodotti`,round(((count(distinct (case when (`ds2`.`id_prodotto` is not null) then `d`.`id_documento` end)) * 100.0) / count(distinct `d`.`id_documento`)),2) AS `percentuale_cross_selling` from ((((`supermercato`.`promozioni` `pr` join `supermercato`.`promozioni_prodotti` `pp` on((`pr`.`id_promozione` = `pp`.`id_promozione`))) join `supermercato`.`dettagli_scontrino` `ds1` on((`pp`.`id_prodotto` = `ds1`.`id_prodotto`))) join `supermercato`.`documenti` `d` on((`ds1`.`id_documento` = `d`.`id_documento`))) left join `supermercato`.`dettagli_scontrino` `ds2` on(((`ds1`.`id_documento` = `ds2`.`id_documento`) and `ds2`.`id_prodotto` in (select `supermercato`.`promozioni_prodotti`.`id_prodotto` from `supermercato`.`promozioni_prodotti` where (`supermercato`.`promozioni_prodotti`.`id_promozione` = `pr`.`id_promozione`)) is false))) group by `pr`.`id_promozione`,`pr`.`nome`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_customer_lifetime_value`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_customer_lifetime_value`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_customer_lifetime_value` AS select `c`.`id_cliente` AS `id_cliente`,`c`.`nome` AS `nome`,`c`.`cognome` AS `cognome`,sum(`d`.`importo`) AS `totale_speso`,count(`d`.`id_documento`) AS `numero_acquisti`,avg(`d`.`importo`) AS `spesa_media_per_acquisto` from (`supermercato`.`documenti` `d` join `supermercato`.`clienti` `c` on((`d`.`id_cliente` = `c`.`id_cliente`))) where (`d`.`tipo_documento` = 'Scontrino') group by `c`.`id_cliente`,`c`.`nome`,`c`.`cognome` order by `totale_speso` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_distribuzione_peso_volume_scaffali`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_distribuzione_peso_volume_scaffali`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_distribuzione_peso_volume_scaffali` AS select `s`.`id_scaffale` AS `id_scaffale`,`s`.`tipo` AS `tipo`,sum((`p`.`peso_kg` * `ps`.`quantita`)) AS `peso_totale`,sum((`p`.`volume_cm3` * `ps`.`quantita`)) AS `volume_totale`,round(((sum((`p`.`peso_kg` * `ps`.`quantita`)) / `s`.`capacita_peso`) * 100),2) AS `utilizzo_peso_percent`,round(((sum((`p`.`volume_cm3` * `ps`.`quantita`)) / `s`.`capacita_volume`) * 100),2) AS `utilizzo_volume_percent` from ((`supermercato`.`scaffali` `s` join `supermercato`.`prodotti_scaffali` `ps` on((`s`.`id_scaffale` = `ps`.`id_scaffale`))) join `supermercato`.`prodotti` `p` on((`ps`.`id_prodotto` = `p`.`id_prodotto`))) group by `s`.`id_scaffale`,`s`.`tipo` order by `utilizzo_peso_percent` desc,`utilizzo_volume_percent` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_efficienza_casse`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_efficienza_casse`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_efficienza_casse` AS select `c`.`id_cassa` AS `id_cassa`,`c`.`tipo` AS `tipo_cassa`,count(`d`.`id_documento`) AS `numero_scontrini`,sum(`d`.`importo`) AS `ricavi_totali`,round((sum(`d`.`importo`) / count(distinct concat(`d`.`data_documento`,hour(`d`.`ora_documento`)))),2) AS `euro_per_ora`,round((count(`d`.`id_documento`) / count(distinct concat(`d`.`data_documento`,hour(`d`.`ora_documento`)))),2) AS `scontrini_per_ora` from (`supermercato`.`casse` `c` join `supermercato`.`documenti` `d` on((`c`.`id_cassa` = `d`.`id_cassa`))) where (`d`.`tipo_documento` = 'Scontrino') group by `c`.`id_cassa`,`c`.`tipo` order by `euro_per_ora` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_efficienza_mq`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_efficienza_mq`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_efficienza_mq` AS select `e`.`id_edificio` AS `id_edificio`,`e`.`nome_edificio` AS `nome_edificio`,`e`.`superficie_mq` AS `superficie_mq`,sum(`d`.`importo`) AS `ricavi_totali`,round((sum(`d`.`importo`) / `e`.`superficie_mq`),2) AS `ricavi_per_mq` from (((`supermercato`.`edifici` `e` join `supermercato`.`uffici` `u` on((`e`.`id_edificio` = `u`.`id_edificio`))) join `supermercato`.`dipendenti` `p` on((`u`.`id_ufficio` = `p`.`id_ufficio`))) join `supermercato`.`documenti` `d` on((`p`.`id_dipendente` = `d`.`id_dipendente`))) where (`d`.`tipo_documento` = 'Scontrino') group by `e`.`id_edificio`,`e`.`nome_edificio`,`e`.`superficie_mq` order by `ricavi_per_mq` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_fornitori_affidabili`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_fornitori_affidabili`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_fornitori_affidabili` AS select `f`.`id_fornitore` AS `id_fornitore`,`f`.`nome_fornitore` AS `nome_fornitore`,`f`.`affidabilita` AS `affidabilita` from `supermercato`.`fornitori` `f` order by `f`.`affidabilita` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_fornitori_convenienti`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_fornitori_convenienti`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_fornitori_convenienti` AS select `f`.`id_fornitore` AS `id_fornitore`,`f`.`nome_fornitore` AS `nome_fornitore`,round(avg(`cf`.`prezzo_offerta`),2) AS `prezzo_medio_offerta`,round(avg(`p`.`prezzo_vendita`),2) AS `prezzo_medio_vendita`,round((avg(`p`.`prezzo_vendita`) - avg(`cf`.`prezzo_offerta`)),2) AS `margine_medio` from ((`supermercato`.`fornitori` `f` join `supermercato`.`catalogo_fornitori` `cf` on((`f`.`id_fornitore` = `cf`.`id_fornitore`))) join `supermercato`.`prodotti` `p` on((`cf`.`id_prodotto` = `p`.`id_prodotto`))) group by `f`.`id_fornitore`,`f`.`nome_fornitore` order by `margine_medio` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_frequenza_vendita_prodotto`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_frequenza_vendita_prodotto`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_frequenza_vendita_prodotto` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,count(distinct `ds`.`id_documento`) AS `frequenza_vendita` from (`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) group by `p`.`id_prodotto`,`p`.`nome_prodotto` order by `frequenza_vendita` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_impatto_promozioni_vendite`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_impatto_promozioni_vendite`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_impatto_promozioni_vendite` AS select (case when ((`ds`.`sconto_percentuale` > 0) or (`pp`.`id_promozione` is not null)) then 'In Promozione' else 'Non in Promozione' end) AS `stato_promozione`,sum(`ds`.`quantita`) AS `totale_quantita`,sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) AS `ricavi_totali`,avg(`ds`.`sconto_percentuale`) AS `sconto_medio` from ((`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) left join `supermercato`.`promozioni_prodotti` `pp` on((`p`.`id_prodotto` = `pp`.`id_prodotto`))) group by `stato_promozione`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_margine_lordo_prodotti`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_margine_lordo_prodotti`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_margine_lordo_prodotti` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,round(avg(`p`.`prezzo_vendita`),2) AS `prezzo_medio_vendita`,round(avg(`cf`.`prezzo_offerta`),2) AS `prezzo_medio_acquisto`,round((avg(`p`.`prezzo_vendita`) - avg(`cf`.`prezzo_offerta`)),2) AS `margine_lordo_unitario`,sum(`ds`.`quantita`) AS `vendite_totali`,round(((avg(`p`.`prezzo_vendita`) - avg(`cf`.`prezzo_offerta`)) * sum(`ds`.`quantita`)),2) AS `margine_totale` from ((`supermercato`.`prodotti` `p` left join `supermercato`.`catalogo_fornitori` `cf` on((`p`.`id_prodotto` = `cf`.`id_prodotto`))) left join `supermercato`.`dettagli_scontrino` `ds` on((`p`.`id_prodotto` = `ds`.`id_prodotto`))) group by `p`.`id_prodotto`,`p`.`nome_prodotto` order by `margine_totale` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_performance_edifici`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_performance_edifici`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_performance_edifici` AS select `e`.`id_edificio` AS `id_edificio`,`e`.`nome_edificio` AS `nome_edificio`,`e`.`indirizzo` AS `indirizzo`,sum(`d`.`importo`) AS `ricavi_totali`,count(`d`.`id_documento`) AS `numero_scontrini`,round((sum(`d`.`importo`) / count(`d`.`id_documento`)),2) AS `carrello_medio` from (((`supermercato`.`edifici` `e` join `supermercato`.`uffici` `u` on((`e`.`id_edificio` = `u`.`id_edificio`))) join `supermercato`.`dipendenti` `p` on((`u`.`id_ufficio` = `p`.`id_ufficio`))) join `supermercato`.`documenti` `d` on((`p`.`id_dipendente` = `d`.`id_dipendente`))) where (`d`.`tipo_documento` = 'Scontrino') group by `e`.`id_edificio`,`e`.`nome_edificio`,`e`.`indirizzo` order by `ricavi_totali` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_performance_marche`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_performance_marche`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_performance_marche` AS select `m`.`id_marca` AS `id_marca`,`m`.`nome_marca` AS `nome_marca`,sum(`ds`.`quantita`) AS `quantita_venduta`,sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) AS `ricavi_totali` from ((`supermercato`.`prodotti` `p` join `supermercato`.`marche` `m` on((`p`.`id_marca` = `m`.`id_marca`))) join `supermercato`.`dettagli_scontrino` `ds` on((`p`.`id_prodotto` = `ds`.`id_prodotto`))) group by `m`.`id_marca`,`m`.`nome_marca` order by `ricavi_totali` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_performance_produttori`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_performance_produttori`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_performance_produttori` AS select `pr`.`id_produttore` AS `id_produttore`,`pr`.`nome_produttore` AS `nome_produttore`,sum(`ds`.`quantita`) AS `quantita_venduta`,sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) AS `ricavi_totali` from (((`supermercato`.`prodotti` `p` join `supermercato`.`marche` `m` on((`p`.`id_marca` = `m`.`id_marca`))) join `supermercato`.`produttori` `pr` on((`m`.`id_produttore` = `pr`.`id_produttore`))) join `supermercato`.`dettagli_scontrino` `ds` on((`p`.`id_prodotto` = `ds`.`id_prodotto`))) group by `pr`.`id_produttore`,`pr`.`nome_produttore` order by `ricavi_totali` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_performance_titoli`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_performance_titoli`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_performance_titoli` AS select `t`.`nome_titolo` AS `nome_titolo`,count(distinct `dt`.`id_dipendente`) AS `numero_dipendenti`,sum(`d`.`importo`) AS `ricavi_totali`,round(avg(`d`.`importo`),2) AS `media_vendite_per_dipendente` from (((`supermercato`.`dipendenti_titoli` `dt` join `supermercato`.`titoli` `t` on((`dt`.`id_titolo` = `t`.`id_titolo`))) join `supermercato`.`dipendenti` `dp` on((`dt`.`id_dipendente` = `dp`.`id_dipendente`))) join `supermercato`.`documenti` `d` on((`dp`.`id_dipendente` = `d`.`id_dipendente`))) where (`d`.`tipo_documento` = 'Scontrino') group by `t`.`id_titolo`,`t`.`nome_titolo` order by `ricavi_totali` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_picchi_carico`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_picchi_carico`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_picchi_carico` AS select `d`.`data_documento` AS `data_documento`,hour(`d`.`ora_documento`) AS `ora`,count(`d`.`id_documento`) AS `numero_scontrini`,count(distinct `d`.`id_dipendente`) AS `cassieri_attivi`,round((count(`d`.`id_documento`) / nullif(count(distinct `d`.`id_dipendente`),0)),2) AS `scontrini_per_cassiere` from `supermercato`.`documenti` `d` where (`d`.`tipo_documento` = 'Scontrino') group by `d`.`data_documento`,hour(`d`.`ora_documento`) order by `numero_scontrini` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_prezzo_vs_volumi`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_prezzo_vs_volumi`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_prezzo_vs_volumi` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,round(avg(`cf`.`prezzo_offerta`),2) AS `prezzo_medio_acquisto`,sum(`ds`.`quantita`) AS `quantita_venduta` from ((`supermercato`.`prodotti` `p` left join `supermercato`.`catalogo_fornitori` `cf` on((`p`.`id_prodotto` = `cf`.`id_prodotto`))) left join `supermercato`.`dettagli_scontrino` `ds` on((`p`.`id_prodotto` = `ds`.`id_prodotto`))) group by `p`.`id_prodotto`,`p`.`nome_prodotto` order by `quantita_venduta` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_prodotti_associati`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_prodotti_associati`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_prodotti_associati` AS select `p1`.`nome_prodotto` AS `prodotto_1`,`p2`.`nome_prodotto` AS `prodotto_2`,count(0) AS `frequenza` from (((`supermercato`.`dettagli_scontrino` `ds1` join `supermercato`.`dettagli_scontrino` `ds2` on(((`ds1`.`id_documento` = `ds2`.`id_documento`) and (`ds1`.`id_prodotto` < `ds2`.`id_prodotto`)))) join `supermercato`.`prodotti` `p1` on((`ds1`.`id_prodotto` = `p1`.`id_prodotto`))) join `supermercato`.`prodotti` `p2` on((`ds2`.`id_prodotto` = `p2`.`id_prodotto`))) group by `p1`.`nome_prodotto`,`p2`.`nome_prodotto` order by `frequenza` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_prodotti_cari_ma_lenti`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_prodotti_cari_ma_lenti`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_prodotti_cari_ma_lenti` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,round(avg(`p`.`prezzo_vendita`),2) AS `prezzo_medio_vendita`,sum(`ds`.`quantita`) AS `quantita_venduta` from (`supermercato`.`prodotti` `p` left join `supermercato`.`dettagli_scontrino` `ds` on((`p`.`id_prodotto` = `ds`.`id_prodotto`))) group by `p`.`id_prodotto`,`p`.`nome_prodotto` having (sum(`ds`.`quantita`) < 50) order by `prezzo_medio_vendita` desc,`quantita_venduta`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_prodotti_meno_venduti`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_prodotti_meno_venduti`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_prodotti_meno_venduti` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,sum(`ds`.`quantita`) AS `totale_venduto` from (`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) group by `p`.`id_prodotto`,`p`.`nome_prodotto` order by `totale_venduto`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_prodotti_piu_venduti`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_prodotti_piu_venduti`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_prodotti_piu_venduti` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,sum(`ds`.`quantita`) AS `totale_venduto` from (`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) group by `p`.`id_prodotto`,`p`.`nome_prodotto` order by `totale_venduto` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_prodotti_stockout`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_prodotti_stockout`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_prodotti_stockout` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,count(0) AS `volte_stockout` from (`supermercato`.`inventario` `i` join `supermercato`.`prodotti` `p` on((`i`.`id_prodotto` = `p`.`id_prodotto`))) where (`i`.`quantita` = 0) group by `p`.`id_prodotto`,`p`.`nome_prodotto` order by `volte_stockout` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_produttivita_ruolo`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_produttivita_ruolo`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_produttivita_ruolo` AS select `r`.`id_ruolo` AS `id_ruolo`,`r`.`nome_ruolo` AS `nome_ruolo`,count(`dp`.`id_dipendente`) AS `numero_dipendenti`,round(avg(`dp`.`stipendio`),2) AS `stipendio_medio`,sum(`d`.`importo`) AS `ricavi_totali`,round((sum(`d`.`importo`) / count(`dp`.`id_dipendente`)),2) AS `ricavi_per_dipendente`,round((avg(`dp`.`stipendio`) / (sum(`d`.`importo`) / count(`dp`.`id_dipendente`))),2) AS `rapporto_stipendio_produttivita` from ((`supermercato`.`ruoli` `r` join `supermercato`.`dipendenti` `dp` on((`r`.`id_ruolo` = `dp`.`id_ruolo`))) left join `supermercato`.`documenti` `d` on(((`dp`.`id_dipendente` = `d`.`id_dipendente`) and (`d`.`tipo_documento` = 'Scontrino')))) group by `r`.`id_ruolo`,`r`.`nome_ruolo` order by `rapporto_stipendio_produttivita`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_promozioni_vs_vendite`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_promozioni_vs_vendite`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_promozioni_vs_vendite` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,count(distinct `pr`.`id_promozione`) AS `numero_promozioni`,sum(`ds`.`quantita`) AS `quantita_venduta`,sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) AS `ricavi_generati` from (((`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) left join `supermercato`.`promozioni_prodotti` `pp` on((`p`.`id_prodotto` = `pp`.`id_prodotto`))) left join `supermercato`.`promozioni` `pr` on((`pp`.`id_promozione` = `pr`.`id_promozione`))) group by `p`.`id_prodotto`,`p`.`nome_prodotto` order by `numero_promozioni` desc,`quantita_venduta` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_quantita_venduta_prodotto`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_quantita_venduta_prodotto`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_quantita_venduta_prodotto` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,sum(`ds`.`quantita`) AS `quantita_totale` from (`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) group by `p`.`id_prodotto`,`p`.`nome_prodotto` order by `quantita_totale` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_redditivita_per_lavoro`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_redditivita_per_lavoro`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_redditivita_per_lavoro` AS select `c`.`lavoro` AS `lavoro`,sum(`d`.`importo`) AS `ricavo_totale`,avg(`d`.`importo`) AS `spesa_media` from (`supermercato`.`documenti` `d` join `supermercato`.`clienti` `c` on((`d`.`id_cliente` = `c`.`id_cliente`))) where (`d`.`tipo_documento` = 'Scontrino') group by `c`.`lavoro` order by `ricavo_totale` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_redditivita_per_sesso`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_redditivita_per_sesso`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_redditivita_per_sesso` AS select `c`.`sesso` AS `sesso`,sum(`d`.`importo`) AS `ricavo_totale`,avg(`d`.`importo`) AS `spesa_media` from (`supermercato`.`documenti` `d` join `supermercato`.`clienti` `c` on((`d`.`id_cliente` = `c`.`id_cliente`))) where (`d`.`tipo_documento` = 'Scontrino') group by `c`.`sesso` order by `ricavo_totale` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_ricavi_per_categoria`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_ricavi_per_categoria`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_ricavi_per_categoria` AS select `c`.`id_categoria` AS `id_categoria`,`c`.`nome_categoria` AS `nome_categoria`,sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) AS `ricavi_totali` from (((`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) join `supermercato`.`sottocategorie` `sc` on((`p`.`id_sottocategoria` = `sc`.`id_sottocategoria`))) join `supermercato`.`categorie` `c` on((`sc`.`id_categoria` = `c`.`id_categoria`))) group by `c`.`id_categoria`,`c`.`nome_categoria` order by `ricavi_totali` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_ricavi_per_sottocategoria`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_ricavi_per_sottocategoria`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_ricavi_per_sottocategoria` AS select `sc`.`id_sottocategoria` AS `id_sottocategoria`,`sc`.`nome_sottocategoria` AS `nome_sottocategoria`,sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) AS `ricavi_totali` from ((`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) join `supermercato`.`sottocategorie` `sc` on((`p`.`id_sottocategoria` = `sc`.`id_sottocategoria`))) group by `sc`.`id_sottocategoria`,`sc`.`nome_sottocategoria` order by `ricavi_totali` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_ricavi_reparti`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_ricavi_reparti`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_ricavi_reparti` AS select `r`.`id_reparto` AS `id_reparto`,`r`.`nome_reparto` AS `nome_reparto`,sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (ifnull(`ds`.`sconto_percentuale`,0) / 100)))) AS `ricavi_totali` from ((((`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) join (select `supermercato`.`prodotti_scaffali`.`id_prodotto` AS `id_prodotto`,`supermercato`.`prodotti_scaffali`.`id_scaffale` AS `id_scaffale`,row_number() OVER (PARTITION BY `supermercato`.`prodotti_scaffali`.`id_prodotto` ORDER BY `supermercato`.`prodotti_scaffali`.`quantita` desc,`supermercato`.`prodotti_scaffali`.`data_collocazione` desc )  AS `rn` from `supermercato`.`prodotti_scaffali`) `ps` on(((`p`.`id_prodotto` = `ps`.`id_prodotto`) and (`ps`.`rn` = 1)))) join `supermercato`.`scaffali` `s` on((`ps`.`id_scaffale` = `s`.`id_scaffale`))) join `supermercato`.`reparti` `r` on((`s`.`id_reparto` = `r`.`id_reparto`))) group by `r`.`id_reparto`,`r`.`nome_reparto` order by `ricavi_totali` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_ricavo_per_categoria`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_ricavo_per_categoria`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_ricavo_per_categoria` AS select `c`.`id_categoria` AS `id_categoria`,`c`.`nome_categoria` AS `nome_categoria`,sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) AS `ricavo_categoria` from (((`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) join `supermercato`.`sottocategorie` `sc` on((`p`.`id_sottocategoria` = `sc`.`id_sottocategoria`))) join `supermercato`.`categorie` `c` on((`sc`.`id_categoria` = `c`.`id_categoria`))) group by `c`.`id_categoria`,`c`.`nome_categoria` order by `ricavo_categoria` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_ricavo_per_prodotto`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_ricavo_per_prodotto`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_ricavo_per_prodotto` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) AS `ricavo_prodotto` from (`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) group by `p`.`id_prodotto`,`p`.`nome_prodotto` order by `ricavo_prodotto` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_ricavo_totale`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_ricavo_totale`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_ricavo_totale` AS select sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) AS `ricavo_totale` from `supermercato`.`dettagli_scontrino` `ds`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_roi_promozioni`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_roi_promozioni`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_roi_promozioni` AS select `pr`.`id_promozione` AS `id_promozione`,`pr`.`nome` AS `nome`,`pr`.`data_inizio` AS `data_inizio`,`pr`.`data_fine` AS `data_fine`,sum((`ds`.`quantita` * `ds`.`prezzo_unitario`)) AS `ricavi_lordi`,sum((((`ds`.`quantita` * `ds`.`prezzo_unitario`) * `ds`.`sconto_percentuale`) / 100)) AS `valore_sconti`,sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) AS `ricavi_netto`,(case when (sum((((`ds`.`quantita` * `ds`.`prezzo_unitario`) * `ds`.`sconto_percentuale`) / 100)) = 0) then NULL else round(((sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) - sum((((`ds`.`quantita` * `ds`.`prezzo_unitario`) * `ds`.`sconto_percentuale`) / 100))) / sum((((`ds`.`quantita` * `ds`.`prezzo_unitario`) * `ds`.`sconto_percentuale`) / 100))),2) end) AS `roi_stimato` from (((`supermercato`.`promozioni` `pr` join `supermercato`.`promozioni_prodotti` `pp` on((`pr`.`id_promozione` = `pp`.`id_promozione`))) join `supermercato`.`prodotti` `p` on((`pp`.`id_prodotto` = `p`.`id_prodotto`))) join `supermercato`.`dettagli_scontrino` `ds` on((`p`.`id_prodotto` = `ds`.`id_prodotto`))) group by `pr`.`id_promozione`,`pr`.`nome`,`pr`.`data_inizio`,`pr`.`data_fine` order by `roi_stimato` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_rotazione_alimentare_vs_non`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_rotazione_alimentare_vs_non`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_rotazione_alimentare_vs_non` AS select (case when (`p`.`is_alimentare` = 1) then 'Alimentare' else 'Non Alimentare' end) AS `tipo_prodotto`,sum(`ds`.`quantita`) AS `vendite_totali`,avg(`i`.`quantita`) AS `giacenza_media`,round((sum(`ds`.`quantita`) / nullif(avg(`i`.`quantita`),0)),2) AS `tasso_rotazione` from ((`supermercato`.`prodotti` `p` left join `supermercato`.`dettagli_scontrino` `ds` on((`p`.`id_prodotto` = `ds`.`id_prodotto`))) left join `supermercato`.`inventario` `i` on((`p`.`id_prodotto` = `i`.`id_prodotto`))) group by `tipo_prodotto`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_rotazione_magazzino`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_rotazione_magazzino`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_rotazione_magazzino` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,sum(`ds`.`quantita`) AS `vendite_totali`,avg(`i`.`quantita`) AS `giacenza_media`,round((sum(`ds`.`quantita`) / nullif(avg(`i`.`quantita`),0)),2) AS `tasso_rotazione` from ((`supermercato`.`prodotti` `p` left join `supermercato`.`dettagli_scontrino` `ds` on((`p`.`id_prodotto` = `ds`.`id_prodotto`))) left join `supermercato`.`inventario` `i` on((`p`.`id_prodotto` = `i`.`id_prodotto`))) group by `p`.`id_prodotto`,`p`.`nome_prodotto` order by `tasso_rotazione` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_sconto_medio_prodotto`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_sconto_medio_prodotto`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_sconto_medio_prodotto` AS select `p`.`id_prodotto` AS `id_prodotto`,`p`.`nome_prodotto` AS `nome_prodotto`,avg(`ds`.`sconto_percentuale`) AS `sconto_medio` from (`supermercato`.`dettagli_scontrino` `ds` join `supermercato`.`prodotti` `p` on((`ds`.`id_prodotto` = `p`.`id_prodotto`))) group by `p`.`id_prodotto`,`p`.`nome_prodotto` order by `sconto_medio` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_sconto_medio_totale`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_sconto_medio_totale`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_sconto_medio_totale` AS select avg(`ds`.`sconto_percentuale`) AS `sconto_medio_totale` from `supermercato`.`dettagli_scontrino` `ds`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_sottocategorie_low_performance`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_sottocategorie_low_performance`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_sottocategorie_low_performance` AS select `sc`.`id_sottocategoria` AS `id_sottocategoria`,`sc`.`nome_sottocategoria` AS `nome_sottocategoria`,count(distinct `ds`.`id_documento`) AS `numero_scontrini`,sum(((`ds`.`quantita` * `ds`.`prezzo_unitario`) * (1 - (`ds`.`sconto_percentuale` / 100)))) AS `ricavi_totali` from ((`supermercato`.`sottocategorie` `sc` join `supermercato`.`prodotti` `p` on((`sc`.`id_sottocategoria` = `p`.`id_sottocategoria`))) left join `supermercato`.`dettagli_scontrino` `ds` on((`p`.`id_prodotto` = `ds`.`id_prodotto`))) group by `sc`.`id_sottocategoria`,`sc`.`nome_sottocategoria` having ((`ricavi_totali` < 1000) or (`numero_scontrini` < 50)) order by `ricavi_totali`,`numero_scontrini`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_spesa_per_eta`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_spesa_per_eta`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_spesa_per_eta` AS select (floor((((to_days(curdate()) - to_days(`c`.`data_nascita`)) / 365) / 10)) * 10) AS `fascia_eta`,sum(`d`.`importo`) AS `ricavo_totale`,avg(`d`.`importo`) AS `spesa_media` from (`supermercato`.`documenti` `d` join `supermercato`.`clienti` `c` on((`d`.`id_cliente` = `c`.`id_cliente`))) where (`d`.`tipo_documento` = 'Scontrino') group by `fascia_eta` order by `ricavo_totale` desc;

-- -----------------------------------------------------
-- View `supermercato`.`vw_tempo_consegna_fornitori`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_tempo_consegna_fornitori`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_tempo_consegna_fornitori` AS select `o`.`id_ordine` AS `id_ordine`,`f`.`nome_fornitore` AS `nome_fornitore`,(to_days(`o`.`data_prevista_consegna`) - to_days(`o`.`data_ordine`)) AS `giorni_attesi`,avg((to_days(`o`.`data_prevista_consegna`) - to_days(`o`.`data_ordine`))) OVER (PARTITION BY `f`.`id_fornitore` )  AS `media_giorni_fornitore` from (`supermercato`.`ordini_fornitore` `o` join `supermercato`.`fornitori` `f` on((`o`.`id_fornitore` = `f`.`id_fornitore`))) where (`o`.`stato` = 'Consegnato');

-- -----------------------------------------------------
-- View `supermercato`.`vw_utilizzo_scaffali`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_utilizzo_scaffali`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_utilizzo_scaffali` AS select `s`.`id_scaffale` AS `id_scaffale`,`s`.`tipo` AS `tipo`,`s`.`capacita_peso` AS `capacita_peso`,`s`.`capacita_volume` AS `capacita_volume`,sum((`p`.`peso_kg` * `ps`.`quantita`)) AS `peso_totale`,sum((`p`.`volume_cm3` * `ps`.`quantita`)) AS `volume_totale`,round(((sum((`p`.`peso_kg` * `ps`.`quantita`)) / `s`.`capacita_peso`) * 100),2) AS `utilizzo_peso_percent`,round(((sum((`p`.`volume_cm3` * `ps`.`quantita`)) / `s`.`capacita_volume`) * 100),2) AS `utilizzo_volume_percent`,(case when ((sum((`p`.`peso_kg` * `ps`.`quantita`)) > `s`.`capacita_peso`) or (sum((`p`.`volume_cm3` * `ps`.`quantita`)) > `s`.`capacita_volume`)) then 'Sovraccarico' when ((sum((`p`.`peso_kg` * `ps`.`quantita`)) < (`s`.`capacita_peso` * 0.3)) and (sum((`p`.`volume_cm3` * `ps`.`quantita`)) < (`s`.`capacita_volume` * 0.3))) then 'Sottoutilizzato' else 'Normale' end) AS `stato_scaffale` from ((`supermercato`.`scaffali` `s` join `supermercato`.`prodotti_scaffali` `ps` on((`s`.`id_scaffale` = `ps`.`id_scaffale`))) join `supermercato`.`prodotti` `p` on((`ps`.`id_prodotto` = `p`.`id_prodotto`))) group by `s`.`id_scaffale`,`s`.`tipo`,`s`.`capacita_peso`,`s`.`capacita_volume` order by `stato_scaffale`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_vendite_giornaliere`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_vendite_giornaliere`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_vendite_giornaliere` AS select `d`.`data_documento` AS `giorno`,sum(`d`.`importo`) AS `totale_giornaliero` from `supermercato`.`documenti` `d` where (`d`.`tipo_documento` = 'Scontrino') group by `d`.`data_documento` order by `d`.`data_documento`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_vendite_mensili`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_vendite_mensili`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_vendite_mensili` AS select year(`d`.`data_documento`) AS `anno`,month(`d`.`data_documento`) AS `mese`,sum(`d`.`importo`) AS `totale_mensile` from `supermercato`.`documenti` `d` where (`d`.`tipo_documento` = 'Scontrino') group by year(`d`.`data_documento`),month(`d`.`data_documento`) order by `anno`,`mese`;

-- -----------------------------------------------------
-- View `supermercato`.`vw_vendite_settimanali`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `supermercato`.`vw_vendite_settimanali`;
USE `supermercato`;
CREATE  OR REPLACE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `supermercato`.`vw_vendite_settimanali` AS select yearweek(`d`.`data_documento`,1) AS `anno_settimana`,sum(`d`.`importo`) AS `totale_settimanale` from `supermercato`.`documenti` `d` where (`d`.`tipo_documento` = 'Scontrino') group by yearweek(`d`.`data_documento`,1) order by `anno_settimana`;
USE `supermercato`;

DELIMITER $$
USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_insert_marche_produttore`
BEFORE INSERT ON `supermercato`.`marche`
FOR EACH ROW
BEGIN
    IF NEW.id_produttore IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: Una marca deve avere un produttore specificato'; -- Regola 7
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_insert_prodotti_margine`
BEFORE INSERT ON `supermercato`.`prodotti`
FOR EACH ROW
BEGIN
    DECLARE prezzo_acquisto_min DECIMAL(10,2);
    
    -- Trova il prezzo di acquisto minimo dai fornitori
    SELECT MIN(prezzo_offerta) INTO prezzo_acquisto_min
    FROM catalogo_fornitori
    WHERE id_prodotto = NEW.id_prodotto
    AND CURDATE() BETWEEN data_inizio AND data_fine;
    
    IF prezzo_acquisto_min IS NOT NULL AND NEW.prezzo_vendita <= prezzo_acquisto_min THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: Il prezzo di vendita deve essere maggiore del prezzo di acquisto';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_insert_prodotti_scadenza`
BEFORE INSERT ON `supermercato`.`prodotti`
FOR EACH ROW
BEGIN
    IF NEW.is_alimentare = TRUE AND NEW.scadenza IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: I prodotti alimentari devono avere una data di scadenza';
    END IF;
    
    IF NEW.is_alimentare = FALSE AND NEW.scadenza IS NOT NULL THEN
        SET NEW.scadenza = NULL; -- Regola 16
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_update_prodotti_scadenza`
BEFORE UPDATE ON `supermercato`.`prodotti`
FOR EACH ROW
BEGIN
    IF NEW.is_alimentare = TRUE AND NEW.scadenza IS NULL THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: I prodotti alimentari devono avere una data di scadenza';
    END IF;
    
    IF NEW.is_alimentare = FALSE AND NEW.scadenza IS NOT NULL THEN
        SET NEW.scadenza = NULL; -- Regola 16
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`after_delete_catalogo_fornitori_check`
AFTER DELETE ON `supermercato`.`catalogo_fornitori`
FOR EACH ROW
BEGIN
    DECLARE count_prodotti INT;
    
    SELECT COUNT(*) INTO count_prodotti
    FROM catalogo_fornitori
    WHERE id_fornitore = OLD.id_fornitore;
    
    IF count_prodotti = 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: Un fornitore deve offrire almeno un prodotto';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_update_catalogo_fornitori_date`
BEFORE UPDATE ON `supermercato`.`catalogo_fornitori`
FOR EACH ROW
BEGIN
    IF NEW.data_fine <= NEW.data_inizio THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: La data di fine offerta deve essere successiva alla data di inizio';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`after_delete_dettagli_ordine_check`
AFTER DELETE ON `supermercato`.`dettagli_ordine`
FOR EACH ROW
BEGIN
    DECLARE count_dettagli INT;
    
    SELECT COUNT(*) INTO count_dettagli
    FROM dettagli_ordine
    WHERE id_ordine = OLD.id_ordine;
    
    IF count_dettagli = 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: Un ordine deve contenere almeno un prodotto';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_insert_dettagli_ordine_fornitore`
BEFORE INSERT ON `supermercato`.`dettagli_ordine`
FOR EACH ROW
BEGIN
    DECLARE id_fornitore_ordine INT;
    DECLARE prodotto_disponibile INT;
    
    -- Ottieni il fornitore dell'ordine
    SELECT id_fornitore INTO id_fornitore_ordine
    FROM ordini_fornitore
    WHERE id_ordine = NEW.id_ordine;
    
    -- Verifica che il fornitore offra questo prodotto
    SELECT COUNT(*) INTO prodotto_disponibile
    FROM catalogo_fornitori
    WHERE id_fornitore = id_fornitore_ordine
    AND id_prodotto = NEW.id_prodotto
    AND CURDATE() BETWEEN data_inizio AND data_fine;
    
    IF prodotto_disponibile = 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: Il fornitore non offre questo prodotto';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`after_insert_dipendente_verifica_titoli`
AFTER INSERT ON `supermercato`.`dipendenti`
FOR EACH ROW
BEGIN
    DECLARE titoli_richiesti INT;
    DECLARE titoli_posseduti INT;
    
    -- Conta i titoli richiesti per il ruolo
    SELECT COUNT(*) INTO titoli_richiesti
    FROM ruoli_titoli
    WHERE id_ruolo = NEW.id_ruolo;
    
    -- Se ci sono titoli richiesti, verifica che il dipendente li possieda
    IF titoli_richiesti > 0 THEN
        SELECT COUNT(DISTINCT rt.id_titolo) INTO titoli_posseduti
        FROM ruoli_titoli rt
        INNER JOIN dipendenti_titoli dt ON rt.id_titolo = dt.id_titolo
        WHERE rt.id_ruolo = NEW.id_ruolo 
        AND dt.id_dipendente = NEW.id_dipendente;
        
        IF titoli_posseduti < titoli_richiesti THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'Errore: Il dipendente non possiede tutti i titoli richiesti per questo ruolo';
        END IF;
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_insert_dipendente_maggiorenne`
BEFORE INSERT ON `supermercato`.`dipendenti`
FOR EACH ROW
BEGIN
    IF TIMESTAMPDIFF(YEAR, NEW.data_nascita, CURDATE()) < 18 THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'Errore: Il dipendente deve essere maggiorenne';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_update_dipendente_maggiorenne`
BEFORE UPDATE ON `supermercato`.`dipendenti`
FOR EACH ROW
BEGIN
    IF TIMESTAMPDIFF(YEAR, NEW.data_nascita, CURDATE()) < 18 THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'Errore: Il dipendente deve essere maggiorenne';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_update_documenti_verifica_totale`
BEFORE UPDATE ON `supermercato`.`documenti`
FOR EACH ROW
BEGIN
    DECLARE totale_calcolato DECIMAL(10,2);
    
    IF NEW.tipo_documento = 'Scontrino' THEN
        SELECT COALESCE(SUM(
            prezzo_unitario * quantita * (1 - sconto_percentuale/100)
        ), 0)
        INTO totale_calcolato
        FROM dettagli_scontrino
        WHERE id_documento = NEW.id_documento;
        
        IF ABS(NEW.importo - totale_calcolato) > 0.01 THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'Errore: Il totale dello scontrino non corrisponde alla somma dei dettagli';
        END IF;
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`after_delete_dettagli_scontrino_check`
AFTER DELETE ON `supermercato`.`dettagli_scontrino`
FOR EACH ROW
BEGIN
    DECLARE count_dettagli INT;
    
    SELECT COUNT(*) INTO count_dettagli
    FROM dettagli_scontrino
    WHERE id_documento = OLD.id_documento;
    
    IF count_dettagli = 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: Uno scontrino deve avere almeno un prodotto';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_insert_dettagli_scontrino_promozioni`
BEFORE INSERT ON `supermercato`.`dettagli_scontrino`
FOR EACH ROW
BEGIN
    DECLARE sconto_promo DECIMAL(5,2);
    DECLARE data_vendita DATE;
    
    -- Ottieni la data del documento
    SELECT data_documento INTO data_vendita
    FROM documenti
    WHERE id_documento = NEW.id_documento;
    
    -- Cerca promozioni attive per il prodotto
    SELECT MAX(p.sconto_percentuale) INTO sconto_promo
    FROM promozioni p
    INNER JOIN promozioni_prodotti pp ON p.id_promozione = pp.id_promozione
    WHERE pp.id_prodotto = NEW.id_prodotto
    AND data_vendita BETWEEN p.data_inizio AND p.data_fine;
    
    -- Applica lo sconto se trovato (Regola 32)
    IF sconto_promo IS NOT NULL AND sconto_promo > NEW.sconto_percentuale THEN
        SET NEW.sconto_percentuale = sconto_promo;
    END IF;
    
    -- Verifica che lo sconto non superi il massimo consentito (Regola 31)
    IF NEW.sconto_percentuale > COALESCE(sconto_promo, 100) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: Lo sconto applicato supera il massimo consentito';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_insert_prodotti_scaffali_capacita`
BEFORE INSERT ON `supermercato`.`prodotti_scaffali`
FOR EACH ROW
BEGIN
    DECLARE peso_totale DECIMAL(10,2);
    DECLARE volume_totale DECIMAL(10,2);
    DECLARE peso_prodotto DECIMAL(6,3);
    DECLARE volume_prodotto INT;
    DECLARE capacita_peso_scaffale DECIMAL(10,2);
    DECLARE capacita_volume_scaffale DECIMAL(10,2);
    
    -- Ottieni le caratteristiche del prodotto
    SELECT peso_kg, volume_cm3 
    INTO peso_prodotto, volume_prodotto
    FROM prodotti 
    WHERE id_prodotto = NEW.id_prodotto;
    
    -- Ottieni la capacit dello scaffale
    SELECT capacita_peso, capacita_volume 
    INTO capacita_peso_scaffale, capacita_volume_scaffale
    FROM scaffali 
    WHERE id_scaffale = NEW.id_scaffale;
    
    -- Calcola peso e volume gi presenti sullo scaffale
    SELECT COALESCE(SUM(p.peso_kg * ps.quantita), 0),
           COALESCE(SUM(p.volume_cm3 * ps.quantita), 0)
    INTO peso_totale, volume_totale
    FROM prodotti_scaffali ps
    INNER JOIN prodotti p ON ps.id_prodotto = p.id_prodotto
    WHERE ps.id_scaffale = NEW.id_scaffale;
    
    -- Aggiungi il nuovo carico
    SET peso_totale = peso_totale + (peso_prodotto * NEW.quantita);
    SET volume_totale = volume_totale + (volume_prodotto * NEW.quantita);
    
    -- Verifica i limiti
    IF peso_totale > capacita_peso_scaffale THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: Il peso totale supera la capacit dello scaffale';
    END IF;
    
    IF volume_totale > capacita_volume_scaffale THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: Il volume totale supera la capacit dello scaffale';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_insert_promozioni_date`
BEFORE INSERT ON `supermercato`.`promozioni`
FOR EACH ROW
BEGIN
    IF NEW.data_fine <= NEW.data_inizio THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: La data di fine promozione deve essere successiva alla data di inizio';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_update_promozioni_date`
BEFORE UPDATE ON `supermercato`.`promozioni`
FOR EACH ROW
BEGIN
    IF NEW.data_fine <= NEW.data_inizio THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: La data di fine promozione deve essere successiva alla data di inizio';
    END IF;
END$$

USE `supermercato`$$
CREATE
DEFINER=`root`@`localhost`
TRIGGER `supermercato`.`before_insert_promozioni_prodotti_unica`
BEFORE INSERT ON `supermercato`.`promozioni_prodotti`
FOR EACH ROW
BEGIN
    DECLARE promozioni_attive INT;
    DECLARE data_inizio_nuova DATE;
    DECLARE data_fine_nuova DATE;
    
    -- Ottieni le date della promozione
    SELECT data_inizio, data_fine 
    INTO data_inizio_nuova, data_fine_nuova
    FROM promozioni
    WHERE id_promozione = NEW.id_promozione;
    
    -- Verifica sovrapposizioni con altre promozioni
    SELECT COUNT(*) INTO promozioni_attive
    FROM promozioni_prodotti pp
    INNER JOIN promozioni p ON pp.id_promozione = p.id_promozione
    WHERE pp.id_prodotto = NEW.id_prodotto
    AND pp.id_promozione != NEW.id_promozione
    AND (
        (data_inizio_nuova BETWEEN p.data_inizio AND p.data_fine)
        OR (data_fine_nuova BETWEEN p.data_inizio AND p.data_fine)
        OR (p.data_inizio BETWEEN data_inizio_nuova AND data_fine_nuova)
    );
    
    IF promozioni_attive > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Errore: Il prodotto ha gi una promozione attiva in questo periodo';
    END IF;
END$$


DELIMITER ;

SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;


CREATE DEFINER=`root`@`localhost` TRIGGER `after_insert_dipendente_verifica_titoli` AFTER INSERT ON `dipendenti` FOR EACH ROW BEGIN
    DECLARE titoli_richiesti INT;
    DECLARE titoli_posseduti INT;
    
    -- Conta i titoli richiesti per il ruolo
    SELECT COUNT(*) INTO titoli_richiesti
    FROM ruoli_titoli
    WHERE id_ruolo = NEW.id_ruolo;
    
    -- Se ci sono titoli richiesti, verifica che il dipendente li possieda
    IF titoli_richiesti > 0 THEN
        SELECT COUNT(DISTINCT rt.id_titolo) INTO titoli_posseduti
        FROM ruoli_titoli rt
        INNER JOIN dipendenti_titoli dt ON rt.id_titolo = dt.id_titolo
        WHERE rt.id_ruolo = NEW.id_ruolo 
        AND dt.id_dipendente = NEW.id_dipendente;
        
        IF titoli_posseduti < titoli_richiesti THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'Errore: Il dipendente non possiede tutti i titoli richiesti per questo ruolo';
        END IF;
    END IF;
END